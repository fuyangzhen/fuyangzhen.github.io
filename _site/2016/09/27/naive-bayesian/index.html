<!DOCTYPE html>
<html lang="en-us">

  <!-- Enable mathjax-->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']],
                                processEscapes: true, 
                                processEnvironments: true}});
</script>
<script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML">
</script>
<link href="https://fuyangzhen.github.io/assets/zoom-jQuery/zoom.css" rel="stylesheet">
<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="https://fuyangzhen.github.io/assets/zoom-jQuery/zoom.js"></script>
<script src="https://fuyangzhen.github.io/assets/zoom-jQuery/transition.js"></script>

<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Naive bayesian &middot; Young
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110129992-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-110129992-1');
</script>

</head>
<div id="backtop">
   <a href="#">^</a>
</div>


  <body class="theme-base-08">
    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>Have problems? Easy-peasy, just press the restart button.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <a class="sidebar-nav-item" href="/list-AIR/">AIR</a>
    
    
    
    
    
    <a class="sidebar-nav-item" href="/list-D&A/">D&A</a>
    
    
    
    
    
    <a class="sidebar-nav-item" href="/list-Design%20Patterns/">Design Patterns</a>
    
    
    
    
    
    <a class="sidebar-nav-item" href="/list-Memo/">Memo</a>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <!--<a class="sidebar-nav-item" href="/archive/v1.0.0.zip">Download</a>
    <a class="sidebar-nav-item" href="">GitHub project</a>
    <span class="sidebar-nav-item">Currently v1.0.0</span>
    -->
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; <a href=http://www.linkedin.com/in/fuyangzhen>Young 2019 </a> All rights reserved.
        </p> </div> </div>

    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Young</a>
            <small>Anything I do that may help others, I'll post it here.</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Naive bayesian</h1>
  <span class="post-date">27 Sep 2016</span>
  <h2 id="1-简介">1 简介</h2>
<blockquote>
  <p>朴素贝叶斯是一种构建分类器的简单方法。该分类器模型会给问题实例分配用特征值表示的类标签，类标签取自有限集合。它不是训练这种分类器的单一算法，而是一系列基于相同原理的算法：所有朴素贝叶斯分类器都假定样本每个特征与其他特征都不相关。举个例子，如果一种水果其具有红，圆，直径大概3英寸等特征，该水果可以被判定为是苹果。尽管这些特征相互依赖或者有些特征由其他特征决定，然而朴素贝叶斯分类器认为这些属性在判定该水果是否为苹果的概率分布上独立的。</p>
</blockquote>

<blockquote>
  <p>对于某些类型的概率模型，在监督式学习的样本集中能获取得非常好的分类效果。在许多实际应用中，朴素贝叶斯模型参数估计使用最大似然估计方法；换而言之，在不用到贝叶斯概率或者任何贝叶斯模型的情况下，朴素贝叶斯模型也能奏效。</p>
</blockquote>

<blockquote>
  <p>尽管是带着这些朴素思想和过于简单化的假设，但朴素贝叶斯分类器在很多复杂的现实情形中仍能够取得相当好的效果。2004年，<a href="http://www.cs.unb.ca/~hzhang/publications/FLAIRS04ZhangH.pdf">一篇分析贝叶斯分类器问题的文章</a>揭示了朴素贝叶斯分类器取得看上去不可思议的分类效果的若干理论上的原因。尽管如此，2006年有<a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.122.5901&amp;rep=rep1&amp;type=pdfPDF">一篇文章</a>详细比较了各种分类方法，发现更新的方法（如提升树和随机森林）的性能超过了贝叶斯分类器。</p>
</blockquote>

<blockquote>
  <p>朴素贝叶斯分类器的一个优势在于只需要根据少量的训练数据估计出必要的参数（变量的均值和方差）。由于变量独立假设，只需要估计各个变量的方法，而不需要确定整个协方差矩阵。</p>
</blockquote>

<p>以上来自<a href="https://zh.wikipedia.org/wiki/朴素贝叶斯分类器">wiki百科</a>。</p>

<!--more-->

<h2 id="2-朴素贝叶斯概率模型">2 朴素贝叶斯概率模型</h2>
<p>理论上，概率模型分类器是一个条件概率模型：</p>

<p><img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/28079310be466655aad2c65f245e4cb412e8b117" alt="1" /></p>

<p>独立的类别变量<code class="highlighter-rouge">C</code>有若干类别，条件依赖于若干特征变量 
<code class="highlighter-rouge">F1,F2,...,Fn</code>。但问题在于如果特征数量<code class="highlighter-rouge">n</code>较大或者每个特征能取大量值时，基于概率模型列出概率表变得不现实。所以我们修改这个模型使之变得可行。 贝叶斯定理有以下式子：</p>

<p><img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/f2c8595ffd1c98706f679d2586ccb73c95336d71" alt="2" /></p>

<p>用朴素的语言可以表达为：</p>

<p><img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/679e25db34f602d562e503af6d772125f78ab31e" alt="3" /></p>

<p>实际中，我们只关心分式中的分子部分，因为分母不依赖于<code class="highlighter-rouge">C</code>而且特征<code class="highlighter-rouge">Fi</code>的值是给定的，于是分母可以认为是一个常数。这样分子就等价于联合分布模型：</p>

<p><img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/28079310be466655aad2c65f245e4cb412e8b117" alt="4" /></p>

<p>重复使用链式法则，可将该式写成条件概率的形式，如下所示：</p>

<p><img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/28079310be466655aad2c65f245e4cb412e8b117" alt="5" /><br />
 <img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/31845b172ec5c0b9b5ed916deaf929a14b7e2a87" alt="" /> 
<img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/0be67f84d7213f91f3ea647923462aab194ab86d" alt="" /> <br />
<img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/a474bd86779001186e9c6ba2b9b3801a81510efb" alt="" /><br />
<img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/1a76dc3801fdf20ea4ae680b7be6b301fceea193" alt="" /><br />
<img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/d7367ba741b4ca24e90dd690d2894e4a797a05e9" alt="" /></p>

<p>现在“朴素”的条件独立假设开始发挥作用:假设每个特征<code class="highlighter-rouge">Fi,j!=i</code>是条件独立的。这就意味着：</p>

<p><img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/14ae825a0763ef510201f3f3bc22ae21728d3b6d" alt="6" /></p>

<p>对于<code class="highlighter-rouge">i!=j</code>，所以联合分布模型可以表达为：</p>

<p><img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/4d98d85764ca413554badf4f63c43a0aaa7a7631" alt="7" /></p>

<p>这意味着上述假设下，类变量<code class="highlighter-rouge">C</code>的条件分布可以表达为：</p>

<p><img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/7e2c830eac90468e5839385df574ae31d4fc1dbc" alt="8" /></p>

<p>其中<code class="highlighter-rouge">Z</code>(证据因子)是一个只依赖于<code class="highlighter-rouge">F1,...,Fn</code>等的缩放因子，当特征变量的值已知时是一个常数。由于分解成所谓的类先验概率<code class="highlighter-rouge">p(C)</code>和独立概率分布<code class="highlighter-rouge">p(Fi|C)</code>，上述概率模型的可掌控性得到很大的提高。如果这是一个<code class="highlighter-rouge">k</code>分类问题，且每个<code class="highlighter-rouge">p(Fi|C=c)</code>可以表达为<code class="highlighter-rouge">r</code>个参数，于是相应的朴素贝叶斯模型有<code class="highlighter-rouge">(k−1) + nrk</code>个参数。实际应用中，通常取<code class="highlighter-rouge">k=2</code>（二分类问题），<code class="highlighter-rouge">r=1</code>(伯努利分布作为特征），因此模型的参数个数为<code class="highlighter-rouge">2n+1</code>，其中<code class="highlighter-rouge">n</code>是二值分类特征的个数。</p>
<h3 id="从概率模型中构造分类器">从概率模型中构造分类器</h3>
<p>讨论至此为止我们导出了独立分布特征模型，也就是朴素贝叶斯概率模型。朴素贝叶斯分类器包括了这种模型和相应的决策规则。一个普通的规则就是选出最有可能的那个：这就是大家熟知的最大后验概率（MAP）决策准则。相应的分类器便是如下定义的classify公式：<br />
<img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/1f164389c02ead6cc42c72ab5821032961af8f01" alt="" /><br />
即选取能使上式达到最大的<code class="highlighter-rouge">c</code>作为预测样本的类。</p>
<h2 id="3-代码实现">3 代码实现</h2>
<p>朴素贝叶斯应用常见领域就是垃圾邮件识别，这里我们选取另一类似文字识别领域：征婚广告信息，来比较两个城市在广告用词上是否不同。若不同，他们各自的常用词又是哪些？</p>

<p>利用<code class="highlighter-rouge">feedparse</code>RSS源解析器，来下载所需的相关文档。在<code class="highlighter-rouge">anaconda3-4.1.0</code>环境下用<code class="highlighter-rouge">conda install feedparser</code>命令来安装<code class="highlighter-rouge">feedparser</code>模块。</p>

<p>可用下面的方式来获取文本信息：</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ny</span><span class="o">=</span><span class="n">feedparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">'http://newyork.craigslist.org/stp/index.rss'</span><span class="p">)</span>
<span class="n">sf</span><span class="o">=</span><span class="n">feedparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">'http://sfbay.craigslist.org/stp/index.rss'</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="31-词典生成函数">3.1 词典生成函数</h3>
<p>函数传入单词的list，然后返回用到的词的词典list：</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">feedparser</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">array</span>

<span class="k">def</span> <span class="nf">createVocabList</span><span class="p">(</span><span class="n">dataSet</span><span class="p">):</span>
    <span class="n">vocabSet</span><span class="o">=</span><span class="nb">set</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">document</span> <span class="ow">in</span> <span class="n">dataSet</span><span class="p">:</span>
        <span class="n">vocabSet</span><span class="o">=</span><span class="n">vocabSet</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">vocabSet</span><span class="p">)</span>
</code></pre></div></div>
<h3 id="32-词频统计函数">3.2 词频统计函数</h3>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">bagOfWords2VecMN</span><span class="p">(</span><span class="n">vocabList</span><span class="p">,</span><span class="n">inputSet</span><span class="p">):</span>
    <span class="n">returnVec</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">vocabList</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">inputSet</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">vocabList</span><span class="p">:</span>
            <span class="n">returnVec</span><span class="p">[</span><span class="n">vocabList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">word</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="c">#         else:</span>
<span class="c">#             print('the word: %s is not in my Vocabulary!'%word)</span>
    <span class="k">return</span> <span class="n">returnVec</span>
</code></pre></div></div>
<h3 id="33-朴素贝叶斯分类器训练函数">3.3 朴素贝叶斯分类器训练函数</h3>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">trainNB0</span><span class="p">(</span><span class="n">trainMatrix</span><span class="p">,</span><span class="n">trainCategory</span><span class="p">):</span>
    <span class="n">numTrainDocs</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">trainMatrix</span><span class="p">)</span>            <span class="c">#输入文本的总个数</span>
    <span class="n">numWords</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">trainMatrix</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>             <span class="c">#每个文本对应的词典总词数</span>
    <span class="n">pAbusive</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">trainCategory</span><span class="p">)</span><span class="o">/</span><span class="n">numTrainDocs</span> <span class="c">#文本可能属于类别1的概率</span>
    <span class="n">p0Num</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">numWords</span><span class="p">)</span>
    <span class="n">p1Num</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">numWords</span><span class="p">)</span>
    <span class="n">p0Denom</span><span class="o">=</span><span class="mi">2</span>
    <span class="n">p1Denom</span><span class="o">=</span><span class="mi">2</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numTrainDocs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">trainCategory</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>              <span class="c">#将标记中属于类别1的拿出来统计</span>
            <span class="n">p1Num</span> <span class="o">+=</span> <span class="n">trainMatrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>          <span class="c">#问题文本中各个词出现的次数</span>
            <span class="n">p1Denom</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">trainMatrix</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>   <span class="c">#累加类别1文本的总词数</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p0Num</span> <span class="o">+=</span> <span class="n">trainMatrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">p0Denom</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">trainMatrix</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">p1Vect</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p1Num</span><span class="o">/</span><span class="n">p1Denom</span><span class="p">)</span>
    <span class="n">p0Vect</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p0Num</span><span class="o">/</span><span class="n">p0Denom</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p0Vect</span><span class="p">,</span><span class="n">p1Vect</span><span class="p">,</span><span class="n">pAbusive</span>
</code></pre></div></div>
<h3 id="34-分类函数">3.4 分类函数</h3>
<p>利用训练好的分类器返回的结果，就可以基于朴素贝叶斯的概率准则来判断类别了，其中采用ln函数可以防止太多的概率小数累乘，导致计算结果下溢：</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">classifyNB</span><span class="p">(</span><span class="n">vec2Classify</span><span class="p">,</span><span class="n">p0Vec</span><span class="p">,</span><span class="n">p1Vec</span><span class="p">,</span><span class="n">pClass1</span><span class="p">):</span>
    <span class="n">p1</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">vec2Classify</span><span class="o">*</span><span class="n">p1Vec</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pClass1</span><span class="p">)</span>    <span class="c">#ln(a*b)=ln(a)+ln(b)</span>
    <span class="n">p0</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">vec2Classify</span><span class="o">*</span><span class="n">p0Vec</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">pClass1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p1</span><span class="o">&gt;</span><span class="n">p0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
</code></pre></div></div>
<h3 id="35-文本解析函数">3.5 文本解析函数</h3>
<p>将从rss获取的文本信息，解析提取成单词的list：</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">textParse</span><span class="p">(</span><span class="n">bigString</span><span class="p">):</span>
    <span class="c">#bigString=str(bigString)</span>
    <span class="n">listOfTokens</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">r'\W*'</span><span class="p">,</span><span class="n">bigString</span><span class="p">)</span>  <span class="c">#注意大写的W是正则匹配任何非字母数字字符</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">tok</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">listOfTokens</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">]</span>
</code></pre></div></div>
<p>留言中出现最多的代词，介词，冠词等组成了语言中冗余和结构辅助性内容，这对分类器的性能有着不小的影响，去掉这些词可使样本具有更高的代表性，特征更加突出：</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">calcMostFreq</span><span class="p">(</span><span class="n">vocabList</span><span class="p">,</span><span class="n">fullText</span><span class="p">):</span>
    <span class="n">freqDict</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">vocabList</span><span class="p">:</span>
        <span class="n">freqDict</span><span class="p">[</span><span class="n">token</span><span class="p">]</span><span class="o">=</span><span class="n">fullText</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="n">sortedFreq</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">freqDict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span><span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sortedFreq</span><span class="p">[:</span><span class="mi">30</span><span class="p">]</span>
</code></pre></div></div>
<h3 id="36-操作封装函数">3.6 操作封装函数</h3>
<p>最后写一个便利函数来封装所有操作。随机选取数据的80%用作训练集，剩下的用作测试集：</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">localWords</span><span class="p">(</span><span class="n">feed1</span><span class="p">,</span><span class="n">feed0</span><span class="p">):</span>
    <span class="n">docList</span><span class="o">=</span><span class="p">[];</span> <span class="n">classList</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">fullText</span> <span class="o">=</span><span class="p">[]</span>
    <span class="n">minLen</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feed1</span><span class="p">[</span><span class="s">'entries'</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">feed0</span><span class="p">[</span><span class="s">'entries'</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">minLen</span><span class="p">):</span>
        <span class="n">wordList</span> <span class="o">=</span> <span class="n">textParse</span><span class="p">(</span><span class="n">feed1</span><span class="p">[</span><span class="s">'entries'</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s">'summary'</span><span class="p">])</span>
        <span class="n">docList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wordList</span><span class="p">)</span>
        <span class="n">fullText</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">wordList</span><span class="p">)</span>
        <span class="n">classList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c">#NY is class 1</span>
        <span class="n">wordList</span> <span class="o">=</span> <span class="n">textParse</span><span class="p">(</span><span class="n">feed0</span><span class="p">[</span><span class="s">'entries'</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s">'summary'</span><span class="p">])</span>
        <span class="n">docList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wordList</span><span class="p">)</span>
        <span class="n">fullText</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">wordList</span><span class="p">)</span>
        <span class="n">classList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">vocabList</span> <span class="o">=</span> <span class="n">createVocabList</span><span class="p">(</span><span class="n">docList</span><span class="p">)</span><span class="c">#create vocabulary</span>

    <span class="n">top30Words</span> <span class="o">=</span> <span class="n">calcMostFreq</span><span class="p">(</span><span class="n">vocabList</span><span class="p">,</span><span class="n">fullText</span><span class="p">)</span>   <span class="c">#remove top 30 words</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'top30Words:'</span><span class="p">,</span><span class="n">top30Words</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">top30Words</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">vocabList</span><span class="p">:</span>
            <span class="n">vocabList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            
    <span class="n">trainingSet</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">minLen</span><span class="p">);</span><span class="n">testSet</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">randIndex</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">minLen</span><span class="p">),</span><span class="mi">2</span><span class="o">*</span><span class="n">minLen</span><span class="p">)</span>
    <span class="n">testSet</span><span class="o">=</span><span class="n">randIndex</span><span class="p">[:</span><span class="mi">20</span><span class="p">];</span><span class="n">trainingSet</span><span class="o">=</span><span class="n">randIndex</span><span class="p">[</span><span class="mi">20</span><span class="p">:]</span>
        
    <span class="n">trainMat</span><span class="o">=</span><span class="p">[];</span><span class="n">trainClasses</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">docIndex</span> <span class="ow">in</span> <span class="n">trainingSet</span><span class="p">:</span>
        <span class="n">trainMat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bagOfWords2VecMN</span><span class="p">(</span><span class="n">vocabList</span><span class="p">,</span><span class="n">docList</span><span class="p">[</span><span class="n">docIndex</span><span class="p">]))</span>
        <span class="n">trainClasses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">classList</span><span class="p">[</span><span class="n">docIndex</span><span class="p">])</span>
    <span class="n">p0V</span><span class="p">,</span><span class="n">p1V</span><span class="p">,</span><span class="n">pSpam</span><span class="o">=</span><span class="n">trainNB0</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">trainMat</span><span class="p">),</span><span class="n">array</span><span class="p">(</span><span class="n">trainClasses</span><span class="p">))</span>
    <span class="n">errorCount</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">docIndex</span> <span class="ow">in</span> <span class="n">testSet</span><span class="p">:</span>
        <span class="n">wordVector</span><span class="o">=</span><span class="n">bagOfWords2VecMN</span><span class="p">(</span><span class="n">vocabList</span><span class="p">,</span><span class="n">docList</span><span class="p">[</span><span class="n">docIndex</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">classifyNB</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">wordVector</span><span class="p">),</span><span class="n">p0V</span><span class="p">,</span><span class="n">p1V</span><span class="p">,</span><span class="n">pSpam</span><span class="p">)</span><span class="o">!=</span><span class="n">classList</span><span class="p">[</span><span class="n">docIndex</span><span class="p">]:</span>
            <span class="n">errorCount</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'the error rate is: '</span><span class="p">,</span><span class="n">errorCount</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">testSet</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">vocabList</span><span class="p">,</span><span class="n">p0V</span><span class="p">,</span><span class="n">p1V</span>
</code></pre></div></div>
<h3 id="37-最具代表性的词汇显示函数">3.7 最具代表性的词汇显示函数</h3>
<p>将两个城市杯提及最多的词汇找出来并排序，看看大家关注的地方有什么不同：</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">getTopWords</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span><span class="n">sf</span><span class="p">):</span>
    <span class="n">vocabList</span><span class="p">,</span><span class="n">p0V</span><span class="p">,</span><span class="n">p1V</span><span class="o">=</span><span class="n">localWords</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span><span class="n">sf</span><span class="p">)</span>
    <span class="n">topNY</span><span class="o">=</span><span class="p">[];</span> <span class="n">topSF</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p0V</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">p0V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">4.8</span> <span class="p">:</span> <span class="n">topSF</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">vocabList</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">p0V</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">p1V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">4.8</span> <span class="p">:</span> <span class="n">topNY</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">vocabList</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">p1V</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="n">sortedSF</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">topSF</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pair</span><span class="p">:</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"--------------------------SF**SF**SF--------------------------"</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sortedSF</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="si">%12</span><span class="s">s'</span><span class="o">%</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">);</span><span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">5</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">()</span>
    <span class="n">sortedNY</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">topNY</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pair</span><span class="p">:</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">--------------------------NY**NY**NY--------------------------"</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sortedNY</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="si">%12</span><span class="s">s'</span><span class="o">%</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">);</span><span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">5</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">()</span>
</code></pre></div></div>
<h2 id="4-代码测试">4 代码测试</h2>
<p>为了更精确地估计分类器的错误率，应该多次迭代后取平均值：</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ny</span><span class="o">=</span><span class="n">feedparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">'http://newyork.craigslist.org/stp/index.rss'</span><span class="p">)</span>
<span class="n">sf</span><span class="o">=</span><span class="n">feedparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">'http://sfbay.craigslist.org/stp/index.rss'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">localWords</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span><span class="n">sf</span><span class="p">)</span>

<span class="c"># 结果如下：</span>
<span class="c"># the error rate is:  0.2</span>
<span class="c"># the error rate is:  0.4</span>
<span class="c"># the error rate is:  0.5</span>
<span class="c"># the error rate is:  0.3</span>
<span class="c"># the error rate is:  0.4</span>
<span class="c"># the error rate is:  0.45</span>
<span class="c"># the error rate is:  0.4</span>
<span class="c"># the error rate is:  0.4</span>
<span class="c"># the error rate is:  0.4</span>
<span class="c"># the error rate is:  0.3</span>
</code></pre></div></div>
<p>这里得出的测试集错误率，能在一定程度上反映出两个城市的文本信息是否有显著差异。若错误率过大(接近0.5)，则说明差异不大；若错误率过小，则说明差异明显。然而这里的数据集规模太小（每个城市各25个），很可能导致随机选取的训练集不平衡，每次训练出来的词频list<code class="highlighter-rouge">p0V、p1V</code>也有很大差异，无法很好地代表每个城市发布的信息的特点，所以每次预测结果也和预期有很大不同。</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">getTopWords</span><span class="p">(</span><span class="n">vocabList</span><span class="p">,</span><span class="n">p0V</span><span class="p">,</span><span class="n">p1V</span><span class="p">)</span>

<span class="c"># 结果如下：</span>
<span class="c"># the error rate is:  0.45</span>
<span class="c"># --------------------------SF**SF**SF--------------------------</span>
<span class="c">#      married         get        here         age  friendship</span>
<span class="c">#          don      things         one        lady     seeking</span>
<span class="c">#         back         all        male         man      family</span>
<span class="c">#         post    educated        cant     forward        also</span>
<span class="c">#     lingerie        need   wondering        find       chill</span>
<span class="c">#        happy       hello        well      please      artist</span>
<span class="c">#        there     between        want        take     nothing</span>
<span class="c">#         area      prefer       title       young        real</span>
<span class="c">#       really      female   travelingrelationship        talk</span>
<span class="c">#         love      fights        feel        when    believes</span>
<span class="c">#         wish        says         his     company        ever</span>
<span class="c">#      wearing        much       years    employed</span>
<span class="c"># --------------------------NY**NY**NY--------------------------</span>
<span class="c">#         nice        post      single         was        want</span>
<span class="c">#         that      female        paul    recently   mccartney</span>
<span class="c">#      sitting    favorite         get       buddy        fall</span>
<span class="c">#          did        send     panties        whatconversation</span>
<span class="c">#         here       enjoy     waiting       place     lesbian</span>
<span class="c">#         host      mature        from         now         let</span>
<span class="c">#        times         few        best</span>
</code></pre></div></div>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2019/03/10/Memo/">
            Memo
            <small>10 Mar 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2019/03/04/DP-Builder-Pattern/">
            Builder Pattern
            <small>04 Mar 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2019/03/04/DP-Bridge-Pattern/">
            Bridge Pattern
            <small>04 Mar 2019</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

        
<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://youngfu.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
